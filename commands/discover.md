---
name: discover
description: Run non-interactive codebase discovery and optionally create GitHub Issues for findings
arguments:
  - name: lens
    description: "Filter analysis: security, quality, perf, docs, or all (default: all)"
    required: false
  - name: create-issues
    description: "Auto-create GitHub Issues for findings"
    required: false
  - name: min-severity
    description: "Minimum severity to report: critical, major, minor, suggestion (default: minor)"
    required: false
---

# /discover

Run non-interactive codebase analysis to identify improvement opportunities.

## Execution

**Agent:** `contextd:contextd-task-executor`
**Context Folding:** Yes - isolate each lens analysis
**Output:** Terminal summary + contextd storage + optional GitHub Issues

## Usage

```bash
# Run all lenses
/discover

# Security analysis only
/discover --lens security

# Multiple lenses
/discover --lens security,quality

# Create issues for major+ findings
/discover --create-issues --min-severity major

# Full analysis with issue creation
/discover --lens all --create-issues
```

## Workflow

### Phase 1: Pre-Flight

```
1. mcp__contextd__memory_search(
     project_id: "<project>",
     query: "discovery analysis findings"
   )
   → Load past discovery results

2. Check repository index:
   - If missing or stale: mcp__contextd__repository_index(path: ".")
   - Note: reindex if HEAD changed since last index

3. Determine lenses to run:
   - Default: all
   - If --lens specified: parse comma-separated list
```

### Phase 2: Lens Analysis (Context Folded)

For each enabled lens, create isolated branch:

```
mcp__contextd__branch_create(
  session_id: "<session>",
  description: "Analyze <lens>",
  budget: 8192,
  timeout_seconds: 300
)
```

**Execute analyzer from `skills/roadmap-discovery/includes/analyzers/`:**

1. Run pattern searches (Grep, Glob)
2. Execute tool commands if applicable
3. Classify findings by severity
4. Apply confidence scoring
5. Cap findings (top 10 per category)

```
mcp__contextd__branch_return(
  branch_id: "<branch>",
  message: "<lens>: Found <n> issues. CRITICAL: <n>, MAJOR: <n>..."
)
```

### Phase 3: Aggregate Results

Combine findings from all lenses:

```json
{
  "summary": {
    "total_findings": <n>,
    "by_severity": { "CRITICAL": <n>, "MAJOR": <n>, ... },
    "by_lens": { "security": <n>, "quality": <n>, ... }
  },
  "findings": [...]
}
```

### Phase 4: Output Generation

**Terminal Summary:**
```
┌─────────────────────────────────────────────────────────────┐
│ Discovery Results                                           │
└─────────────────────────────────────────────────────────────┘

Lenses: security, quality, perf, docs
Total Findings: 15

By Severity:
  CRITICAL: 1
  MAJOR: 5
  MINOR: 7
  SUGGESTION: 2

Top Findings:
  [CRITICAL] sec_001: Hardcoded API key in config
  [MAJOR] perf_001: N+1 query in user list
  [MAJOR] qual_001: No tests for auth module
  ...

Run `/discover --create-issues` to create GitHub Issues.
```

**If --create-issues:**

Filter by --min-severity (default: minor)

For each finding:
```bash
gh issue create \
  --title "[<severity>] <title>" \
  --label "<lens>,discovery" \
  --body "$(cat <<'EOF'
## Description
<description>

## Location
<location>

## Recommendation
<recommendation>

## Effort
<effort>

## References
<references>

---
*Generated by /discover on <date>*
EOF
)"
```

### Phase 5: Memory Recording

```
mcp__contextd__memory_record(
  project_id: "<project>",
  title: "Discovery: <lens> analysis",
  content: "Lenses: <list>. Found <total> issues.
            CRITICAL: <n>, MAJOR: <n>.
            Top: <top 3 titles>.
            Issues created: <count or 'none'>.",
  outcome: "success",
  tags: ["discovery", "<lens>", "<date>"]
)
```

## Lens Details

| Lens | Focus | Key Patterns |
|------|-------|--------------|
| security | Auth, injection, secrets, CVEs | Hardcoded keys, SQL concat, eval() |
| quality | Tests, complexity, duplication | Coverage %, cyclomatic, copy-paste |
| perf | N+1, unbounded, caching | Loop queries, SELECT *, no LIMIT |
| docs | README, API docs, comments | Missing sections, outdated TODOs |

## Severity Filtering

| --min-severity | Includes |
|----------------|----------|
| critical | CRITICAL only |
| major | CRITICAL + MAJOR |
| minor | CRITICAL + MAJOR + MINOR |
| suggestion | All (CRITICAL + MAJOR + MINOR + SUGGESTION) |

## Integration

### With /brainstorm
```
/discover                    # See what needs work
/brainstorm <topic>          # Design improvement
```

### With /onboard
```
/onboard --discover security,quality
```

### Pre-session Context
Run at session start for automatic context gathering.

## Attribution

Uses roadmap-discovery skill adapted from Auto-Claude.
See CREDITS.md for full attribution.
