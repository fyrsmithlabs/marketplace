---
name: discover
description: Use when auditing codebase quality, finding security issues, identifying tech debt, checking test coverage, or scanning for improvements. Runs autonomous analysis across security, quality, performance, and documentation. Say "analyze this codebase", "find issues", "audit security", or "check code quality".
arguments:
  - name: lens
    description: "Filter analysis: security, quality, perf, docs, or all (default: all)"
    required: false
  - name: create-issues
    description: "Auto-create GitHub Issues for findings"
    required: false
  - name: min-severity
    description: "Minimum severity to report: critical, major, minor, suggestion (default: minor)"
    required: false
---

# /discover

Run non-interactive codebase analysis to identify improvement opportunities.

## Execution

**Agent:** Task tool with Explore subagent
**Context Folding:** If contextd available
**Output:** Terminal summary + optional storage + optional GitHub Issues

## Contextd Integration (Optional)

If contextd MCP is available, this command uses:
- `memory_search` for past discovery results
- `branch_create/return` for context isolation
- `memory_record` for persisting findings

If contextd is NOT available:
- Skip memory search (start fresh)
- Run analysis sequentially (no context branches)
- Output to `.claude/discovery/<date>.md` instead of memory

## Usage

```bash
# Run all lenses
/discover

# Security analysis only
/discover --lens security

# Multiple lenses
/discover --lens security,quality

# Create issues for major+ findings
/discover --create-issues --min-severity major

# Full analysis with issue creation
/discover --lens all --create-issues
```

## Workflow

### Phase 1: Pre-Flight

```
1. Check contextd availability:
   - Look for mcp__contextd__* tools
   - Set contextd_available = true/false

2. If contextd_available:
   mcp__contextd__memory_search(
     project_id: "<project>",
     query: "discovery analysis findings"
   )
   → Load past discovery results

3. Determine lenses to run:
   - Default: all
   - If --lens specified: parse comma-separated list
```

### Phase 2: Lens Analysis

**If contextd_available:** Create isolated branch per lens:
```
mcp__contextd__branch_create(
  session_id: "<session>",
  description: "Analyze <lens>",
  budget: 8192,
  timeout_seconds: 300
)
```

**If NOT contextd_available:** Run sequentially without isolation.

**Execute analyzer from `skills/roadmap-discovery/includes/analyzers/`:**

1. Run pattern searches (Grep, Glob)
2. Execute tool commands if applicable
3. Classify findings by severity
4. Apply confidence scoring
5. Cap findings (top 10 per category)

**If contextd_available:**
```
mcp__contextd__branch_return(
  branch_id: "<branch>",
  message: "<lens>: Found <n> issues. CRITICAL: <n>, MAJOR: <n>..."
)
```

### Phase 3: Aggregate Results

Combine findings from all lenses:

```json
{
  "summary": {
    "total_findings": <n>,
    "by_severity": { "CRITICAL": <n>, "MAJOR": <n>, ... },
    "by_lens": { "security": <n>, "quality": <n>, ... }
  },
  "findings": [...]
}
```

### Phase 4: Output Generation

**Terminal Summary:**
```
┌─────────────────────────────────────────────────────────────┐
│ Discovery Results                                           │
└─────────────────────────────────────────────────────────────┘

Lenses: security, quality, perf, docs
Total Findings: 15

By Severity:
  CRITICAL: 1
  MAJOR: 5
  MINOR: 7
  SUGGESTION: 2

Top Findings:
  [CRITICAL] sec_001: Hardcoded API key in config
  [MAJOR] perf_001: N+1 query in user list
  [MAJOR] qual_001: No tests for auth module
  ...

Run `/discover --create-issues` to create GitHub Issues.
```

**If --create-issues:**

Filter by --min-severity (default: minor)

For each finding:
```bash
gh issue create \
  --title "[<severity>] <title>" \
  --label "<lens>,discovery" \
  --body "$(cat <<'EOF'
## Description
<description>

## Location
<location>

## Recommendation
<recommendation>

## Effort
<effort>

## References
<references>

---
*Generated by /discover on <date>*
EOF
)"
```

### Phase 5: Persist Results

**If contextd_available:**
```
mcp__contextd__memory_record(
  project_id: "<project>",
  title: "Discovery: <lens> analysis",
  content: "Lenses: <list>. Found <total> issues.
            CRITICAL: <n>, MAJOR: <n>.
            Top: <top 3 titles>.
            Issues created: <count or 'none'>.",
  outcome: "success",
  tags: ["discovery", "<lens>", "<date>"]
)
```

**If NOT contextd_available:**
Write to `.claude/discovery/<date>-<lens>.md`:
```markdown
# Discovery Results: <date>

## Summary
Lenses: <list>
Total: <n> findings

## Findings
...
```

## Lens Details

| Lens | Focus | Key Patterns |
|------|-------|--------------|
| security | Auth, injection, secrets, CVEs | Hardcoded keys, SQL concat, eval() |
| quality | Tests, complexity, duplication | Coverage %, cyclomatic, copy-paste |
| perf | N+1, unbounded, caching | Loop queries, SELECT *, no LIMIT |
| docs | README, API docs, comments | Missing sections, outdated TODOs |

## Severity Filtering

| --min-severity | Includes |
|----------------|----------|
| critical | CRITICAL only |
| major | CRITICAL + MAJOR |
| minor | CRITICAL + MAJOR + MINOR |
| suggestion | All (CRITICAL + MAJOR + MINOR + SUGGESTION) |

## Integration

### With /brainstorm
```
/discover                    # See what needs work
/brainstorm <topic>          # Design improvement
```

### Pre-session Context
Run at session start for automatic context gathering.

## Attribution

Uses roadmap-discovery skill adapted from Auto-Claude.
See CREDITS.md for full attribution.
