name: Daily Standup

on:
  schedule:
    # Run at 9:00 AM UTC, Monday through Friday
    - cron: '0 9 * * 1-5'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (skip creating discussion)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: read
  discussions: write
  issues: read
  pull-requests: read
  id-token: write

jobs:
  generate-standup:
    runs-on: ubuntu-latest
    outputs:
      standup_title: ${{ steps.extract.outputs.title }}
      standup_body: ${{ steps.extract.outputs.body }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate standup content
        id: generate
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Generate a daily standup report for the fyrsmithlabs organization.

            Use the `gh` CLI to query GitHub data. The CLI is pre-authenticated.

            ## Instructions

            1. Query these fyrsmithlabs repositories:
               - fyrsmithlabs/marketplace
               - fyrsmithlabs/contextd

            2. For each repo, run these gh commands:
               - `gh pr list --repo fyrsmithlabs/<repo> --state open --json number,title,author,createdAt,labels`
               - `gh issue list --repo fyrsmithlabs/<repo> --state open --json number,title,labels,createdAt`
               - `gh api repos/fyrsmithlabs/<repo>/commits --jq '.[0:10] | .[] | {sha: .sha[0:7], message: .commit.message | split("\n")[0], author: .commit.author.name}'`

            3. Synthesize into priority list:
               - CRITICAL: Security issues, failing CI, blocked PRs
               - HIGH: PRs ready to merge, high-priority issues
               - MEDIUM: In-review PRs, medium-priority issues

            4. Generate 3 actionable recommendations

            ## Output Format

            Return a JSON object with:
            - title: "Daily Standup: YYYY-MM-DD"
            - body: Full markdown standup report (use proper markdown formatting)
          claude_args: |
            --allowedTools Bash
            --max-turns 15
            --model claude-sonnet-4-20250514
            --json-schema '{"type":"object","properties":{"title":{"type":"string"},"body":{"type":"string"}},"required":["title","body"]}'

      - name: Extract outputs
        id: extract
        env:
          STRUCTURED_OUTPUT: ${{ steps.generate.outputs.structured_output }}
        run: |
          # Safely extract title and body using jq
          TITLE=$(echo "$STRUCTURED_OUTPUT" | jq -r '.title')
          BODY=$(echo "$STRUCTURED_OUTPUT" | jq -r '.body')

          # Output title
          echo "title=$TITLE" >> "$GITHUB_OUTPUT"

          # Handle multiline body safely
          {
            echo 'body<<STANDUP_EOF'
            echo "$BODY"
            echo 'STANDUP_EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Debug output (dry run only)
        if: ${{ github.event.inputs.dry_run == 'true' }}
        env:
          STANDUP_TITLE: ${{ steps.extract.outputs.title }}
          STANDUP_BODY: ${{ steps.extract.outputs.body }}
        run: |
          echo "=== STANDUP TITLE ==="
          echo "$STANDUP_TITLE"
          echo ""
          echo "=== STANDUP BODY ==="
          echo "$STANDUP_BODY"

  post-discussion:
    needs: generate-standup
    if: ${{ github.event.inputs.dry_run != 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Create GitHub Discussion
        id: create-discussion
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          STANDUP_TITLE: ${{ needs.generate-standup.outputs.standup_title }}
          STANDUP_BODY: ${{ needs.generate-standup.outputs.standup_body }}
        run: |
          # Get repository ID and category ID
          REPO_ID=$(gh api graphql -f query='
            query($owner: String!, $repo: String!) {
              repository(owner: $owner, name: $repo) { id }
            }' -f owner="${GITHUB_REPOSITORY_OWNER}" -f repo="${GITHUB_REPOSITORY#*/}" --jq '.data.repository.id')

          CATEGORY_ID=$(gh api graphql -f query='
            query($owner: String!, $repo: String!) {
              repository(owner: $owner, name: $repo) {
                discussionCategories(first: 10) {
                  nodes { id name }
                }
              }
            }' -f owner="${GITHUB_REPOSITORY_OWNER}" -f repo="${GITHUB_REPOSITORY#*/}" \
            --jq '.data.repository.discussionCategories.nodes[] | select(.name == "Announcements") | .id')

          # Create discussion
          RESULT=$(gh api graphql -f query='
            mutation($repositoryId: ID!, $categoryId: ID!, $title: String!, $body: String!) {
              createDiscussion(input: {repositoryId: $repositoryId, categoryId: $categoryId, title: $title, body: $body}) {
                discussion { url }
              }
            }' -f repositoryId="$REPO_ID" -f categoryId="$CATEGORY_ID" -f title="$STANDUP_TITLE" -f body="$STANDUP_BODY")

          DISCUSSION_URL=$(echo "$RESULT" | jq -r '.data.createDiscussion.discussion.url')
          echo "discussion-url=$DISCUSSION_URL" >> "$GITHUB_OUTPUT"
          echo "‚úÖ Standup posted!"
          echo "üìç $DISCUSSION_URL"
