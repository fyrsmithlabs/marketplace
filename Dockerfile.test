FROM node:20-slim

# Install dependencies
RUN apt-get update && apt-get install -y \
    git \
    curl \
    jq \
    && rm -rf /var/lib/apt/lists/*

# Install Claude Code
RUN npm install -g @anthropic-ai/claude-code

# Create test user (Claude Code doesn't like running as root)
RUN useradd -m -s /bin/bash testuser

# Copy marketplace files
COPY --chown=testuser:testuser . /home/testuser/marketplace

USER testuser
WORKDIR /home/testuser

# Set up Claude config directory
RUN mkdir -p /home/testuser/.claude

# Copy and prepare validation script
RUN chmod +x /home/testuser/marketplace/tests/run-validation.sh

# Default command: run validation tests
CMD ["/home/testuser/marketplace/tests/run-validation.sh"]
