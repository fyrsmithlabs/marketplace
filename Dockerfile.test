FROM node:20-slim

# Install dependencies
RUN apt-get update && apt-get install -y \
    git \
    curl \
    jq \
    && rm -rf /var/lib/apt/lists/*

# Install Claude Code
RUN npm install -g @anthropic-ai/claude-code

# Create test user (Claude Code doesn't like running as root)
RUN useradd -m -s /bin/bash testuser
USER testuser
WORKDIR /home/testuser

# Clone the marketplace repo
RUN git clone https://github.com/fyrsmithlabs/marketplace.git /home/testuser/marketplace

# Set up Claude config directory
RUN mkdir -p /home/testuser/.claude

# Default command: validate plugins and show status
CMD ["bash", "-c", "\
    echo '=== Plugin Validation ===' && \
    cd /home/testuser/marketplace && \
    echo '' && \
    echo 'Validating fs-dev plugin...' && \
    claude plugin validate . 2>&1 || true && \
    echo '' && \
    echo 'Validating contextd plugin...' && \
    claude plugin validate ./plugins/contextd 2>&1 || true && \
    echo '' && \
    echo 'Validating fs-design plugin...' && \
    claude plugin validate ./plugins/fs-design 2>&1 || true && \
    echo '' && \
    echo '=== Test Complete ===' \
"]
